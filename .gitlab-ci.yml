stages:
  - setup
  - push  

print_git_version:
  stage: setup
  script:
    - echo "Checking Git version..."
    - git --version

push_to_github:
  stage: push
  only:
    - main 
  script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$GITHUB_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - git remote | grep -q github || git remote add github git@github.com:shadyemansour/infoVis.git
    - git fetch github
    - |
      BATCH_SIZE=10  
      TOTAL_COMMITS=$(git rev-list --count HEAD ^github/main)  
      ITERATIONS=$((TOTAL_COMMITS / BATCH_SIZE + (TOTAL_COMMITS % BATCH_SIZE > 0)))
      for i in $(seq 1 $ITERATIONS); do
        LAST_COMMIT=$(git rev-parse HEAD~$(($BATCH_SIZE * $i)))
        git push github $LAST_COMMIT:refs/heads/main
      done